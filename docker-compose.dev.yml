version: '3.8'

volumes:
  mongodb:
  mariadb:
  grafana:

services:
  app:
    container_name: ${COMPOSE_PROJECT_NAME}-app
    build:
      context: ./
      dockerfile: .docker/Dockerfile
    working_dir: /var/www/html
    volumes:
      - ./app:/var/www/html:cached
      - ./.docker/app.conf:/etc/apache2/sites-available/000-default.conf
      - ./.docker/symfony_worker.conf:/etc/supervisor/conf.d/symfony_worker.conf
    ports:
      - ${APP_PORT}:${APP_PORT}

  orion:
    container_name: ${COMPOSE_PROJECT_NAME}-orion
    hostname: orion
    image: fiware/orion:${ORION_VERSION}
    depends_on:
      - mongodb
    ports:
      - ${ORION_PORT}:${ORION_PORT}
    command: -dbhost mongodb -logLevel DEBUG
    healthcheck:
      test: curl --fail -s http://orion:${ORION_PORT}/version || exit 1
      interval: 5s
  
  iot-agent:
    container_name: ${COMPOSE_PROJECT_NAME}-agent
    hostname: iot-agent
    image: fiware/iotagent-json:${IOTA_VERSION}
    depends_on:
      - mongodb
    ports:
      - "${IOTA_NORTH_PORT}:${IOTA_NORTH_PORT}"
      - "${IOTA_SOUTH_PORT}:${IOTA_SOUTH_PORT}"
    environment:
      - IOTA_CB_HOST=orion
      - IOTA_CB_PORT=${ORION_PORT}
      - IOTA_NORTH_PORT=${IOTA_NORTH_PORT}
      - IOTA_REGISTRY_TYPE=mongodb
      - IOTA_TIMESTAMP=true
      - IOTA_MONGO_HOST=mongodb
      - IOTA_MONGO_PORT=${MONGODB_PORT}
      - IOTA_MONGO_DB=iotagentjson
      - IOTA_HTTP_PORT=${IOTA_SOUTH_PORT}
      - IOTA_PROVIDER_URL=http://iot-agent:${IOTA_NORTH_PORT}
      - IOTA_DEFAULT_RESOURCE=/iot/json
      - IOTA_CB_NGSI_VERSION=v2
      - IOTA_LOG_LEVEL=DEBUG
      - IOTA_AUTOCAST=true

  cygnus:
    container_name: ${COMPOSE_PROJECT_NAME}-cygnus
    image: fiware/cygnus-ngsi:${CYGNUS_VERSION}
    depends_on:
      - mariadb
    ports:
      - ${CYGNUS_SERVICE_PORT}:${CYGNUS_SERVICE_PORT}
      - ${CYGNUS_API_PORT}:${CYGNUS_API_PORT}
    environment:
      - CYGNUS_MYSQL_HOST=mariadb
      - CYGNUS_MYSQL_PORT=${MARIADB_PORT}
      - CYGNUS_MYSQL_USER=${MARIADB_ROOT_USER}
      - CYGNUS_MYSQL_PASS=${MARIADB_ROOT_PASSWORD}
      - CYGNUS_MYSQL_SERVICE_PORT=${CYGNUS_SERVICE_PORT}
      - CYGNUS_LOG_LEVEL=DEBUG
      - CYGNUS_API_PORT=${CYGNUS_API_PORT}
      - CYGNUS_SERVICE_PORT=${CYGNUS_SERVICE_PORT}
    healthcheck:
      test: curl --fail -s http://cygnus:${CYGNUS_API_PORT}/v1/version || exit 1
      interval: 5s

  mariadb:
    container_name: ${COMPOSE_PROJECT_NAME}-mariadb
    image: mariadb:${MARIADB_VERSION}
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
    volumes:
      - mariadb:/var/lib/mysql

  grafana:
    container_name: ${COMPOSE_PROJECT_NAME}-grafana
    image: grafana/grafana
    ports:
      - ${GRAFANA_PORT}:${GRAFANA_PORT}
    depends_on:
      - mariadb
    volumes:
      - grafana:/var/lib/grafana

  mongodb:
    container_name: ${COMPOSE_PROJECT_NAME}-mongodb
    image: mongo:${MONGODB_VERSION}
    volumes:
      - mongodb:/data
  
  phpmyadmin:
    container_name: ${COMPOSE_PROJECT_NAME}-phpmyadmin
    image: phpmyadmin/phpmyadmin
    ports:
      - ${PHPMYADMIN_PORT}:${PHPMYADMIN_PORT}
    depends_on:
      - mariadb
    environment:
      - PMA_HOST=mariadb
      - PMA_USER=root
      - PMA_PASSWORD=root
      - APACHE_PORT=${PHPMYADMIN_PORT}
      - MEMORY_LIMIT=512M
      - UPLOAD_LIMIT=2M
      - HIDE_PHP_VERSION=true
    
  mongoexpress:
    container_name: ${COMPOSE_PROJECT_NAME}-mongoexpress
    hostname: mongoexpress
    image: mongo-express
    ports:
      - ${MONGOEXPRESS_PORT}:${MONGOEXPRESS_PORT}
    environment:
      - ME_CONFIG_OPTIONS_EDITORTHEME=ambiance
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_BASICAUTH_USERNAME=mongodb
      - ME_CONFIG_BASICAUTH_PASSWORD=mongodb
  
  mailcatcher:
    container_name: ${COMPOSE_PROJECT_NAME}-mailcatcher
    hostname: mailcatcher
    image: dockage/mailcatcher:0.9.0
    ports:
      - 1080:1080
    
